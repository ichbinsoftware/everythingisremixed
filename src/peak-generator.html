<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EVR Peak Generator</title>
    <style>
        body { font-family: monospace; background: #111; color: #eee; padding: 20px; max-width: 800px; margin: 0 auto; }
        h1 { border-bottom: 1px solid #333; padding-bottom: 10px; }
        .track-card { border: 1px solid #333; padding: 15px; margin-bottom: 15px; border-radius: 8px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; }
        .track-info h3 { margin: 0 0 5px 0; color: var(--color); }
        button { cursor: pointer; padding: 8px 16px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-family: inherit; }
        button:hover { background: #444; border-color: #777; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .progress { margin-top: 5px; font-size: 12px; color: #888; }
        .error { color: #ff4444; margin-top: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Waveform Peak Generator</h1>
    <p>This tool uses your browser to decode audio and generate JSON peak files.</p>
    <div id="app">Loading configuration...</div>

    <script>
        const STEMS_URL = '../workers/stems.json';
        const WAVEFORM_WIDTH = 140;

        // Main Application Logic
        async function init() {
            try {
                const res = await fetch(STEMS_URL);
                const stemsData = await res.json();
                renderUI(stemsData);
            } catch (e) {
                document.getElementById('app').innerHTML = `<div class="error">Error loading stems.json: ${e.message}<br>Make sure you are running this via a local server (e.g., python3 -m http.server)</div>`;
            }
        }

        function renderUI(data) {
            const app = document.getElementById('app');
            app.innerHTML = '';

            Object.entries(data).forEach(([trackId, stems]) => {
                const card = document.createElement('div');
                card.className = 'track-card';
                // Use the first stem's color as the track accent
                const color = stems[0]?.color || '#fff';
                card.style.setProperty('--color', color);

                card.innerHTML = `
                    <div class="track-info">
                        <h3>${trackId.toUpperCase()}</h3>
                        <div>${stems.length} Stems</div>
                        <div class="progress" id="prog-${trackId}">Ready to generate</div>
                    </div>
                    <button id="btn-${trackId}" onclick="processTrack('${trackId}', ${JSON.stringify(stems).replace(/"/g, '&quot;')})">
                        Generate JSON
                    </button>
                `;
                app.appendChild(card);
            });
        }

        window.processTrack = async (trackId, stems) => {
            const btn = document.getElementById(`btn-${trackId}`);
            const prog = document.getElementById(`prog-${trackId}`);
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            btn.disabled = true;
            const peaksData = {};

            try {
                for (let i = 0; i < stems.length; i++) {
                    const stem = stems[i];
                    prog.textContent = `Processing stem ${i + 1}/${stems.length}: ${stem.name}...`;
                    
                    // Fetch from live production URL to avoid local path issues
                    // Adjust domain logic if necessary based on your AGENTS.md
                    const url = `https://${trackId}.ichbinsoftware.com/${trackId}/${encodeURIComponent(stem.filename)}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Fetch failed: ${response.status}`);
                    
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                    
                    // Extract peaks using the exact logic from the worker
                    peaksData[i] = extractPeaks(audioBuffer);
                }

                prog.textContent = 'Done! Downloading...';
                downloadJSON(peaksData, `${trackId}_peaks.json`);
                btn.disabled = false;
                btn.textContent = 'Regenerate';
            } catch (e) {
                console.error(e);
                prog.innerHTML = `<span class="error">Error: ${e.message}</span>`;
                btn.disabled = false;
            } finally {
                audioCtx.close();
            }
        };

        // Matches logic in everything-is-remixed-worker.js
        function extractPeaks(audioBuffer) {
            const w = WAVEFORM_WIDTH;
            const d = audioBuffer.getChannelData(0); // Downmix not needed if we just take ch0, or average them
            const s = Math.ceil(d.length / w);
            const peaks = [];
            
            for (let i = 0; i < w; i++) {
                let mn = 1, mx = -1;
                for (let j = 0; j < s; j++) {
                    const idx = (i * s) + j;
                    if (idx < d.length) {
                        const v = d[idx];
                        if (v < mn) mn = v;
                        if (v > mx) mx = v;
                    }
                }
                // Handle silence/empty
                if (mn > mx) { mn = 0; mx = 0; }
                // Round to 4 decimals to save space
                peaks.push({ min: parseFloat(mn.toFixed(4)), max: parseFloat(mx.toFixed(4)) });
            }
            return peaks;
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        init();
    </script>
</body>
</html>